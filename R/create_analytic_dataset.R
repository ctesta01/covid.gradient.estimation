
#' Create Analytic Dataset
#'
#' @examples
#' library(ggdist)
#' df <- create_analytic_dataset()
#'
#'
create_analytic_dataset <- function() {

  # load deaths and 2020 population size data
  deaths <- load_county_covid19_deaths()
  popsizes <- get_county_popsizes()

  # create month column
  deaths %<>% mutate(
    month = paste0(lubridate::year(date), "-", lubridate::month(date))
  )
  # aggregate by month
  deaths %<>% group_by(geoid, county, state, month) %>%
    summarize(
      deaths = sum(deaths_avg)
    )

  # create date version of month column
  deaths %<>% mutate(date = lubridate::ym(month)) %>% select(-month)

  # drop October 2022 (incomplete data)
  deaths %<>% filter(date < lubridate::ymd("2022-10-01"))

  # join in population size estimates
  deaths %<>% left_join(
    popsizes %>% select(GEOID, value) %>% rename(popsize = value),
    by = c('geoid' = 'GEOID')
  )

  # create deaths per 100,000 person-years
  deaths %<>% mutate(crude_rate_per_100k_py = deaths / popsize * 1e5 * 12)

  # add divisions and regions to the dataset
  deaths %<>% mutate(
    division = c(setNames(as.character(state.division), state.name), 'District of Columbia' = 'South Atlantic')[state],
    region = c(setNames(as.character(state.region), state.name), 'District of Columbia' = 'South')[state]
  )

  # incorporate state divisions
  deaths %<>% mutate(division = factor(
    division,
    levels = c(
      'Pacific',
      'West North Central',
      'New England',
      'Mountain',
      'East North Central',
      'Middle Atlantic',
      'West South Central',
      'East South Central',
      'South Atlantic'
    )),
    region = factor(region,
                    levels = c('West', 'Northeast', 'South', 'North Central')))

  # deaths have to be integer for use in the poisson/negative binomial type models
  deaths$deaths %<>% round() %>% as.integer()

  # load cached absms, generated by get_absms_from_acs
  absms <- load_cached_absms()

  # join in area based social metrics
  deaths %<>% left_join(absms, by = c('geoid' = 'GEOID'))

  # get political lean data
  political_lean <- load_mit_election_data()
  deaths %<>% left_join(political_lean, by = c('geoid' = 'county_fips'))

  return(deaths)
}
